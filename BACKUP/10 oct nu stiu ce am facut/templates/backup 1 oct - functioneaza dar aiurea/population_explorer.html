{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row g-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">{{ population_name }}</h2>
                    <p>{{ population_description }}</p>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-4">
                            <form id="filter-form" method="POST" action="{{ url_for('population_explorer_bp.apply_filters') }}">
                                {{ form.hidden_tag() }}
                                {% for field in form if field.name != 'csrf_token' %}
                                <div class="mb-0 row align-items-center">
                                    <label for="{{ field.id }}" class="col-sm-6 col-form-label">{{ field.label.text }}</label>
                                    <div class="col-sm-6">
                                        {{ field(class="form-select form-select-sm" if field.type == "SelectField" else "form-control form-control-sm") }}
                                    </div>
                                </div>
                                {% endfor %}
                                <div class="mt-0">
                                    <button type="submit" class="btn btn-primary btn-sm w-100">Apply Filters</button>
                                </div>
                            </form>
                        </div>

                        <div class="col-sm-8">
                            <ul class="nav nav-tabs mb-3" id="visualization-tabs" role="tablist" data-tab-has-echarts="data-tab-has-echarts">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="age-groups-tab" data-bs-toggle="tab" data-bs-target="#age-groups" type="button" role="tab" aria-controls="age-groups" aria-selected="true">Age Groups</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="gender-distribution-tab" data-bs-toggle="tab" data-bs-target="#gender-distribution" type="button" role="tab" aria-controls="gender-distribution" aria-selected="false">Gender Distribution</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="visualization-content">
                                <div class="tab-pane fade show active" id="age-groups" role="tabpanel" aria-labelledby="age-groups-tab">
                                    <div class="echart-age-groups-pie" data-echart-responsive="true" data-echart-tab="data-echart-tab" style="height: 400px;"></div>
                                </div>
                                <div class="tab-pane fade" id="gender-distribution" role="tabpanel" aria-labelledby="gender-distribution-tab">
                                    <div class="echart-gender-distribution" data-echart-responsive="true" data-echart-tab="data-echart-tab" style="height: 400px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">Filtered Profiles (<span id="profile-count">0</span>)</h3>
                    <div id="tableExample2" data-list='{"valueNames":["profile_name","gender","occupation","birth_date","income_range","education_level"],"page":5,"pagination":true}'>
                        <div class="table-responsive scrollbar">
                            <table class="table table-bordered table-striped fs-10 mb-0">
                                <thead>
                                    <tr>
                                        <th class="sort" data-sort="profile_name">Profile Name</th>
                                        <th class="sort" data-sort="gender">Gender</th>
                                        <th class="sort" data-sort="occupation">Occupation</th>
                                        <th class="sort" data-sort="birth_date">Birth Date</th>
                                        <th class="sort" data-sort="income_range">Income Range</th>
                                        <th class="sort" data-sort="education_level">Education Level</th>
                                    </tr>
                                </thead>
                                <tbody class="list">
                                    {% if profiles %}
                                        {% for profile in profiles %}
                                        <tr>
                                            <td class="profile_name">{{ profile.profile_name }}</td>
                                            <td class="gender">{{ profile.gender }}</td>
                                            <td class="occupation">{{ profile.occupation }}</td>
                                            <td class="birth_date">{{ profile.birth_date }}</td>
                                            <td class="income_range">{{ profile.income_range }}</td>
                                            <td class="education_level">{{ profile.education_level }}</td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td class="profile_name" colspan="6">No data available</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-center mt-3">
                            <button class="btn btn-sm btn-falcon-default me-1" type="button" title="Previous" data-list-pagination="prev">
                                <span class="fas fa-chevron-left"></span>
                            </button>
                            <ul class="pagination mb-0"></ul>
                            <button class="btn btn-sm btn-falcon-default ms-1" type="button" title="Next" data-list-pagination="next">
                                <span class="fas fa-chevron-right"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <button class="btn btn-primary btn-lg">Save Segment</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('filter-form');
        const tableElement = document.getElementById('tableExample2');
        let listObj;

        // Initialize List.js
        function initializeList() {
            if (tableElement.querySelector('tbody tr')) {
                listObj = new List('tableExample2', {
                    valueNames: ['profile_name', 'gender', 'occupation', 'birth_date', 'income_range', 'education_level'],
                    page: 5,
                    pagination: true
                });
            }
        }

        initializeList();

        // Initialize ECharts instances
        var ageGroupsChart = echarts.init(document.querySelector('.echart-age-groups-pie'));
        var genderDistributionChart = echarts.init(document.querySelector('.echart-gender-distribution'));

        // Form submission handler
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(form);

            fetch('{{ url_for('population_explorer_bp.apply_filters') }}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Received data:', data);
                updateTable(data.profiles);
                updateCharts(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while applying filters. Please try again.');
            });
        });

        function updateTable(profiles) {
            const tbody = tableElement.querySelector('tbody');
            tbody.innerHTML = '';
            
            document.getElementById('profile-count').textContent = profiles.length;
            
            profiles.forEach(profile => {
                const row = `
                    <tr>
                        <td class="profile_name">${profile.profile_name}</td>
                        <td class="gender">${profile.gender}</td>
                        <td class="occupation">${profile.occupation}</td>
                        <td class="birth_date">${profile.birth_date}</td>
                        <td class="income_range">${profile.income_range}</td>
                        <td class="education_level">${profile.education_level}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });

            if (listObj) {
                listObj.reIndex();
                listObj.update();
            } else {
                initializeList();
            }
    }

        function updateCharts(data) {
            if (data.age_groups) {
                var ageGroupsOption = {
                    title: {
                        text: 'Age Groups Distribution'
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    series: [{
                        name: 'Age Groups',
                        type: 'pie',
                        radius: ['40%','80%'],
                        data: data.age_groups
                    }]
                };
                ageGroupsChart.setOption(ageGroupsOption);
            }

            if (data.gender_distribution) {
                var genderDistributionOption = {
                    title: {
                        text: 'Gender Distribution'
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    series: [{
                        name: 'Gender',
                        type: 'pie',
                        radius: '80%',
                        data: data.gender_distribution
                    }]
                };
                genderDistributionChart.setOption(genderDistributionOption);
            }
        }

        // Initial data fetch
        fetch('{{ url_for('population_explorer_bp.get_initial_data') }}')
            .then(response => response.json())
            .then(data => {
                console.log('Initial data:', data);
                updateTable(data.profiles);  
                updateCharts(data);
            })
            .catch(error => {
                console.error('Error fetching initial data:', error);
            });

        // Handle window resize
        window.addEventListener('resize', function() {
            ageGroupsChart.resize();
            genderDistributionChart.resize();
        });
    
    });
</script>

{% endblock %}