{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Edit Survey</h5>
                    <form id="surveyForm" method="POST" action="{{ url_for('survey_builder_bp.build_survey') }}">
                        {{ form.hidden_tag() }}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    {{ form.name(class="form-control", id="name", placeholder="Survey Name") }}
                                    <label for="name">Survey Name</label>
                                </div>
                                <div class="form-floating">
                                    {{ form.context_prompt(class="form-control", id="context_prompt", placeholder="Context Prompt") }}
                                    <label for="context_prompt">Context Prompt</label>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex flex-column">
                                <div class="form-floating flex-grow-1">
                                    {{ form.description(class="form-control h-100", id="description", placeholder="Survey Description") }}
                                    <label for="description">Survey Description</label>
                                </div>
                            </div>
                        </div>
                        {{ form.survey_id }}

                        <h6 class="mt-4">Survey Questions:</h6>
                        <div id="queryTemplates">
                            {% if survey and survey.query_templates %}
                                {% for query in survey.query_templates %}
                                <div class="card mb-2 query-card text-bg-dark" data-id="{{ query.id }}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <button type="button" class="btn btn-sm btn-primary edit-query"><i class="fas fa-edit"></i></button>
                                            <div class="query-text-container flex-grow-1 mx-2" style="width: 70%;">
                                                <span class="query-text-label">{{ query.query_text }}</span>
                                                <div class="form-floating d-none">
                                                    <input type="text" class="form-control form-control-sm query-text" value="{{ query.query_text }}" required placeholder="Query Text">
                                                    <label>Query Text</label>
                                                </div>
                                            </div>
                                            <div class="query-schema-container mx-2" style="width: 20%;">
                                                <span class="query-schema-label">{{ query.schema }}</span>
                                                <div class="form-floating d-none">
                                                    <select class="form-control form-control-sm query-schema" required>
                                                        {% for schema in schema_options %}
                                                        <option value="{{ schema }}" {% if schema == query.schema %}selected{% endif %}>{{ schema }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <label>Schema</label>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-danger remove-query"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        
                        <div id="addQueryCard" class="card mb-2">
                            <div class="card-body text-center">
                                <button type="button" class="btn btn-outline-primary mt-3">Add New Query</button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Save Survey</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let editableQueryCard = null;

    // Capture schema options only once after DOM content is fully loaded
    const schemaOptions = [...document.querySelectorAll('.query-schema option')].map(option => option.value);

    function setEditableMode(queryCard, isEditable) {
        const queryTextLabel = queryCard.querySelector('.query-text-label');
        const queryTextInput = queryCard.querySelector('.query-text');
        const queryTextInputContainer = queryCard.querySelector('.query-text-container .form-floating');
        
        const querySchemaLabel = queryCard.querySelector('.query-schema-label');
        const querySchemaSelect = queryCard.querySelector('.query-schema');
        const querySchemaSelectContainer = queryCard.querySelector('.query-schema-container .form-floating');

        const editButton = queryCard.querySelector('.edit-query');
        const deleteButton = queryCard.querySelector('.remove-query');

        let saveButton = queryCard.querySelector('.save-query');
        let cancelButton = queryCard.querySelector('.cancel-edit');

        if (!saveButton) {
            saveButton = document.createElement('button');
            saveButton.classList.add('btn', 'btn-sm', 'btn-success', 'save-query');
            saveButton.innerHTML = '<i class="fas fa-save"></i>';
            saveButton.disabled = true;
            queryCard.querySelector('.d-flex').insertBefore(saveButton, queryCard.querySelector('.query-text-container'));
        }

        if (!cancelButton) {
            cancelButton = document.createElement('button');
            cancelButton.classList.add('btn', 'btn-sm', 'btn-danger', 'cancel-edit');
            cancelButton.innerHTML = '<i class="fas fa-times"></i>';
            queryCard.querySelector('.d-flex').appendChild(cancelButton);
        }

        if (isEditable) {
            queryTextLabel.classList.add('d-none');
            queryTextInputContainer.classList.remove('d-none');

            querySchemaLabel.classList.add('d-none');
            querySchemaSelectContainer.classList.remove('d-none');

            editButton.classList.add('d-none');
            deleteButton.classList.add('d-none');
            saveButton.classList.remove('d-none');
            cancelButton.classList.remove('d-none');
        } else {
            queryTextLabel.classList.remove('d-none');
            queryTextInputContainer.classList.add('d-none');

            querySchemaLabel.classList.remove('d-none');
            querySchemaSelectContainer.classList.add('d-none');

            editButton.classList.remove('d-none');
            deleteButton.classList.remove('d-none');
            saveButton.classList.add('d-none');
            cancelButton.classList.add('d-none');
        }
        toggleAddNewQueryButton();
    }

    function toggleAddNewQueryButton() {
        const addQueryCard = document.getElementById('addQueryCard');
        if (editableQueryCard) {
            addQueryCard.classList.add('d-none');
        } else {
            addQueryCard.classList.remove('d-none');
        }
    }

    document.querySelectorAll('.edit-query').forEach(button => {
        button.addEventListener('click', function() {
            if (editableQueryCard) return;

            const queryCard = button.closest('.query-card');
            editableQueryCard = queryCard;
            setEditableMode(queryCard, true);

            const queryTextInput = queryCard.querySelector('.query-text');
            const saveButton = queryCard.querySelector('.save-query');
            const cancelButton = queryCard.querySelector('.cancel-edit');

            queryTextInput.addEventListener('input', function() {
                saveButton.disabled = queryTextInput.value.trim() === '';
            });
            queryTextInput.dispatchEvent(new Event('input'));

            cancelButton.addEventListener('click', function() {
                setEditableMode(queryCard, false);
                editableQueryCard = null;
                toggleAddNewQueryButton();
            });

            saveButton.addEventListener('click', function() {
                const queryTextLabel = queryCard.querySelector('.query-text-label');
                const querySchemaLabel = queryCard.querySelector('.query-schema-label');

                queryTextLabel.textContent = queryTextInput.value;
                querySchemaLabel.textContent = queryCard.querySelector('.query-schema').value;

                setEditableMode(queryCard, false);
                editableQueryCard = null;
                toggleAddNewQueryButton();
            });
        });
    });

    const addQueryCard = document.getElementById('addQueryCard');
    const queryTemplates = document.getElementById('queryTemplates');

    function createNewQueryCard() {
        const newQueryCard = document.createElement('div');
        newQueryCard.classList.add('card', 'mb-2', 'query-card', 'text-bg-dark');
        newQueryCard.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-sm btn-success save-query"><i class="fas fa-save"></i></button>
                    <div class="query-text-container flex-grow-1 mx-2" style="width: 70%;">
                        <div class="form-floating">
                            <input type="text" class="form-control form-control-sm query-text" required placeholder="Query Text">
                            <label>Query Text</label>
                        </div>
                    </div>
                    <div class="query-schema-container mx-2" style="width: 20%;">
                        <div class="form-floating">
                            <select class="form-control form-control-sm query-schema" required>
                                ${schemaOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                            </select>
                            <label>Schema</label>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger cancel-edit"><i class="fas fa-times"></i></button>
                </div>
            </div>
        `;

        queryTemplates.appendChild(newQueryCard);

        setEditableMode(newQueryCard, true);

        const queryTextInput = newQueryCard.querySelector('.query-text');
        const saveButton = newQueryCard.querySelector('.save-query');
        const cancelButton = newQueryCard.querySelector('.cancel-edit');

        queryTextInput.addEventListener('input', function() {
            saveButton.disabled = queryTextInput.value.trim() === '';
        });
        queryTextInput.dispatchEvent(new Event('input'));

        cancelButton.addEventListener('click', function() {
            queryTemplates.removeChild(newQueryCard);
            editableQueryCard = null;
            toggleAddNewQueryButton();
        });

        saveButton.addEventListener('click', function() {
            const queryTextLabel = newQueryCard.querySelector('.query-text-label');
            const querySchemaLabel = newQueryCard.querySelector('.query-schema-label');

            queryTextLabel.textContent = queryTextInput.value;
            querySchemaLabel.textContent = newQueryCard.querySelector('.query-schema').value;

            setEditableMode(newQueryCard, false);
            editableQueryCard = null;
            toggleAddNewQueryButton();
        });
    }

    addQueryCard.querySelector('button').addEventListener('click', function() {
        if (editableQueryCard) return;

        addQueryCard.classList.add('d-none');
        createNewQueryCard();
    });
    toggleAddNewQueryButton();
});


</script>
{% endblock %}