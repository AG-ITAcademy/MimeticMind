{% extends 'base.html' %}
{% block content %}

<div class="container-fluid">
    <div class="row g-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Survey Analysis: {{ project_survey.survey_alias }}</h2>
                    <div class="mb-3">
                        <select id="question-select" class="form-select">
                            <option value="" disabled selected>Select a question to begin analysis</option>
                            {% for question in questions %}
                                <option value="{{ question.id }}">{{ question.query_text }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-4">
                            <form id="filter-form" method="POST" action="{{ url_for('population_explorer_bp.population_explorer', project_survey_id=project_survey_id) }}">
                                {{ form.hidden_tag() }}
                                {% for field in form if field.name != 'csrf_token' %}
                                <div class="mb-0 row align-items-center">
                                    <label for="{{ field.id }}" class="col-sm-6 col-form-label">{{ field.label.text }}</label>
                                    <div class="col-sm-6">
                                        {{ field(class="form-select form-select-sm" if field.type == "SelectField" else "form-control form-control-sm", disabled=True) }}
                                    </div>
                                </div>
                                {% endfor %}
                                <div class="mt-0">
                                    <button type="submit" class="btn btn-outline-primary btn-sm w-100" disabled>Apply Filters</button>
                                </div>
                            </form>
                        </div>

                        <!-- Analysis Methods Section -->
                        <div class="col-sm-8">
                            <div id="analysis-placeholder" class="text-center py-5">
                                <h4>Select a question to view analysis methods</h4>
                            </div>
                            <ul class="nav nav-tabs" id="analysis-tabs" role="tablist"></ul>
                            <div class="tab-content" id="analysis-content">
                                <!-- THIS IS WHERE THE GRAPHS SHOULD APPEAR -->
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <table id="profile-table" class="table table-striped table-bordered table-md" style="width:100%">
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    const form = $('#filter-form');
    const formFields = $('#filter-form input, #filter-form select');
    const submitButton = $('#filter-form button[type="submit"]');
    const analysisTabs = document.getElementById('analysis-tabs');
    const analysisContent = document.getElementById('analysis-content');
    const analysisPlaceholder = document.getElementById('analysis-placeholder');
    const questionSelect = $('#question-select');
     
    // Initialize DataTable
    const profileTable = $('#profile-table').DataTable({
        pageLength: 5,
        lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
        columns: [
            { data: 'gender', title: 'Gender' },
            { data: 'occupation', title: 'Occupation' },
            { data: 'income_range', title: 'Income Range' },
            { data: 'education_level', title: 'Education Level' },
            { data: 'item', title: 'Item' },
            { data: 'response', title: 'Response' }
        ],
        data: {{ data | tojson | safe }}
    });
    
    // Enable form fields and submit button when a question is selected
    questionSelect.on('change', function() {
        const selectedValue = $(this).val();
        if (selectedValue) {
            formFields.prop('disabled', false);
            submitButton.prop('disabled', false);
            fetchAndUpdateData(new FormData(form[0]));
        } else {
            formFields.prop('disabled', true);
            submitButton.prop('disabled', true);
        }
    });

    form.on('submit', function(e) {
        e.preventDefault();
        fetchAndUpdateData(new FormData(this));
    });

    function fetchAndUpdateData(formData) {
        const pathParts = window.location.pathname.split('/');
        const project_survey_id = pathParts[pathParts.length - 1];
        const selectedQuestionId = $('#question-select').val();
        formData.append('selected_question_id', selectedQuestionId);
        $.ajax({
            url: `/survey_analysis/${project_survey_id}`,
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                console.log("Received table data:", data.data);
                console.log("Received question data:", data.question_data);
                profileTable.clear().rows.add(data.data).draw();
                updateAnalysisContent(data.question_data.methods, selectedQuestionId);
            },
            error: function(error) {
                console.log('Error fetching data:', error);
            }
        });
    }

    function updateAnalysisContent(methods, questionId) {
        analysisContent.innerHTML = '';
        let tabsHtml = '<ul class="nav nav-tabs" role="tablist">';
        let contentHtml = '<div class="tab-content">';

        methods.forEach((method, index) => {
            const tabId = `tab-${method.name.toLowerCase().replace(/\s+/g, '-')}`;
            const isActive = index === 0 ? 'active' : '';
            const chartId = `chart-${method.name.toLowerCase().replace(/\s+/g, '-')}-${questionId}`;

            tabsHtml += `
                <li class="nav-item" role="presentation">
                    <a class="nav-link ${isActive}" id="${tabId}" data-bs-toggle="tab" href="#${tabId}-content" role="tab">${method.name}</a>
                </li>
            `;

            contentHtml += `
                <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="${tabId}-content" role="tabpanel">
                    <p>${method.description}</p>
                    <div id="${chartId}" style="width: 600px; height: 400px;"></div>
                </div>
            `;
        });

        tabsHtml += '</ul>';
        contentHtml += '</div>';

        analysisContent.innerHTML = tabsHtml + contentHtml;

        methods.forEach((method, index) => {
            const chartId = `chart-${method.name.toLowerCase().replace(/\s+/g, '-')}-${questionId}`;
            const chart = echarts.init(document.getElementById(chartId));
            const option = method.chart_option;
            console.log('Option: '+option)
            chart.setOption(option);
        });

        analysisPlaceholder.style.display = 'none';
        analysisContent.style.display = 'block';
    }
});
</script>

{% endblock %}