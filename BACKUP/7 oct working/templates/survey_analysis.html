{% extends 'base.html' %}
{% block content %}

<div class="container-fluid">
    <div class="row g-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Survey Analysis: {{ project_survey.survey_alias }}</h2>
                    <div class="mb-3">
                        <label for="question-select" class="form-label">Select Question:</label>
                        <select id="question-select" class="form-select">
                            <option value="" disabled selected>Select a question to begin analysis</option>
                            {% for question in questions %}
                                <option value="{{ question.id }}">{{ question.query_text }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <!-- Filter Section -->
                        <div class="col-sm-4">
                            {{ form.hidden_tag() }}
                            {% for field in form if field.name != 'csrf_token' %}
                                <div class="mb-2 row align-items-center">
                                    <label class="col-sm-6">{{ field.label.text }}</label>
                                    <div class="col-sm-6">
                                        {{ field(class="form-select form-select-sm" if field.type == "SelectField" else "form-control form-control-sm") }}
                                    </div>
                                </div>
                            {% endfor %}
                            <div class="mt-0">
                                <button type="submit" class="btn btn-outline-primary btn-sm w-100">Apply Filters</button>
                            </div>
                        </div>

                        <!-- Analysis Methods Section -->
                        <div class="col-sm-8">
                            <div id="analysis-placeholder" class="text-center py-5">
                                <h4>Select a question to view analysis methods</h4>
                            </div>
                            <ul class="nav nav-tabs" id="analysis-tabs" role="tablist"></ul>
                            <div class="tab-content" id="analysis-content">
                                <!-- THIS IS WHERE THE GRAPHS SHOULD APPEAR -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Survey Data Table Section -->
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <table id="survey-table" class="table-sm table-striped mb-0 overflow-hidden data-table fs-10" style="width:100%">
                        <!-- Table will be dynamically generated by DataTables -->
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    const questionSelect = document.getElementById('question-select');
    const analysisTabs = document.getElementById('analysis-tabs');
    const analysisContent = document.getElementById('analysis-content');
    const analysisPlaceholder = document.getElementById('analysis-placeholder');
    let surveyTable;

    function initializeSurveyTable() {
        surveyTable = $('#survey-table').DataTable({
            pageLength: 5,
            lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
            columns: [
                { title: 'Gender' },
                { title: 'Income Range' },
                { title: 'Education Level' },
                { title: 'Item' },
                { title: 'Response' }
            ],
            autoWidth: true
        });
    }

    function updateAnalysisContent(methods, questionId, chartData) {
        analysisTabs.innerHTML = '';
        analysisContent.innerHTML = '';
        methods.forEach((method, index) => {
            const tabId = method.name.toLowerCase().replace(/\s+/g, '-');
            const isActive = index === 0 ? 'active' : '';
            const chartType = method.chart_type.toLowerCase().replace(/\s+/g, '-');
            const chartId = `${chartType}-chart-${questionId}`;
            
            // Insert tab
            analysisTabs.insertAdjacentHTML('beforeend', `
                <li class="nav-item" role="presentation">
                    <button class="nav-link ${isActive}" id="${tabId}-tab" data-bs-toggle="tab" 
                            data-bs-target="#${tabId}" type="button" role="tab">${method.name}</button>
                </li>
            `);
            
            // Insert content without script
            analysisContent.insertAdjacentHTML('beforeend', `
                <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="${tabId}" role="tabpanel">
                    <p>Description: ${method.description}</p>
                    <div id="${chartId}" style="width: 800px;height:400px;"></div>
                </div>
            `);
            
            // Create and insert script separately
            const scriptElement = document.createElement('script');
            scriptElement.type = 'text/javascript';
            scriptElement.textContent = `
                (function() {
                    const chart = echarts.init(document.getElementById('${chartId}'));
                    const option = ${JSON.stringify(generateChartOption(method.chart_type, chartData))};
                    chart.setOption(option);
                })();
            `;
            document.getElementById(tabId).appendChild(scriptElement);
        });

        analysisPlaceholder.style.display = 'none';
        analysisTabs.style.display = 'flex';
        analysisContent.style.display = 'block';
    }

    function generateChartOption(chartType, data) {
        const items = data.map(item => item.item);
        const values = data.map(item => item.response);

        switch (chartType.toLowerCase()) {
            case 'box plot':
                return {
                    tooltip: { trigger: 'item', formatter: '{a} <br/>{b}: {c}' },
                    xAxis: { type: 'category', data: ['Response'] },
                    yAxis: { type: 'value' },
                    series: [{
                        name: 'Box Plot',
                        type: 'boxplot',
                        data: [calculateBoxPlotData(values)]
                    }]
                };
            case 'histogram':
                return {
                    tooltip: {},
                    xAxis: { type: 'category', data: items },
                    yAxis: { type: 'value' },
                    series: [{ name: 'Frequency', type: 'bar', data: values }]
                };
            case 'pie chart':
                return {
                    tooltip: { trigger: 'item', formatter: '{a} <br/>{b}: {c} ({d}%)' },
                    series: [{
                        name: 'Responses',
                        type: 'pie',
                        radius: '50%',
                        data: data.map(item => ({ value: item.response, name: item.item }))
                    }]
                };
            case 'word cloud':
                return {
                    series: [{
                        type: 'wordCloud',
                        sizeRange: [12, 50],
                        rotationRange: [-90, 90],
                        shape: 'circle',
                        textStyle: { normal: { color: function() { return 'rgb(' + [
                            Math.round(Math.random() * 160),
                            Math.round(Math.random() * 160),
                            Math.round(Math.random() * 160)
                        ].join(',') + ')';}}},
                        data: data.map(item => ({ name: item.item, value: item.response }))
                    }]
                };
            case 'bar chart':
                return {
                    tooltip: {},
                    xAxis: { type: 'category', data: items },
                    yAxis: { type: 'value' },
                    series: [{ name: 'Responses', type: 'bar', data: values }]
                };
            case 'scatter plot':
                return {
                    xAxis: {},
                    yAxis: {},
                    series: [{
                        symbolSize: 20,
                        data: data.map((item, index) => [index, item.response]),
                        type: 'scatter'
                    }]
                };
            case 'horizontal bar chart':
                return {
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    xAxis: { type: 'value' },
                    yAxis: { type: 'category', data: items },
                    series: [{ name: 'Mean Rank', type: 'bar', data: values }]
                };
            case 'stacked bar chart':
                return {
                    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                    xAxis: { type: 'category', data: items },
                    yAxis: { type: 'value' },
                    series: data.map(item => ({
                        name: item.item,
                        type: 'bar',
                        stack: 'total',
                        data: [item.response]
                    }))
                };
            default:
                return {
                    title: { text: 'Data Visualization' },
                    xAxis: { type: 'category', data: items },
                    yAxis: { type: 'value' },
                    series: [{ name: 'Responses', type: 'line', data: values }]
                };
        }
    }

    function calculateBoxPlotData(values) {
        const sortedValues = values.sort((a, b) => a - b);
        const q1 = sortedValues[Math.floor(sortedValues.length / 4)];
        const median = sortedValues[Math.floor(sortedValues.length / 2)];
        const q3 = sortedValues[Math.floor(sortedValues.length * 3 / 4)];
        const iqr = q3 - q1;
        const min = Math.max(sortedValues[0], q1 - 1.5 * iqr);
        const max = Math.min(sortedValues[sortedValues.length - 1], q3 + 1.5 * iqr);
        return [min, q1, median, q3, max];
    }

    function updateSurveyTable(surveyData) {
        const formattedData = surveyData.map(item => [
            item.gender || 'N/A',
            item.occupation || 'N/A',
            item.income_range || 'N/A',
            item.education_level || 'N/A',
            item.item || 'N/A',
            item.response || 'No Response'
        ]);
        surveyTable.clear().rows.add(formattedData).draw();
    }

    function fetchSurveyData(questionId) {
        return fetch(`/get_survey_data/${questionId}`)
            .then(response => response.json())
            .then(data => updateSurveyTable(data.surveyData));
    }

    function fetchAnalysisMethods(questionId) {
        return fetch(`/get_chart_data/${questionId}`)
            .then(response => response.json())
            .then(data => {
                updateAnalysisContent(data.analysisMethods, questionId, data.chartData);
            });
    }

    function handleQuestionChange() {
        const selectedQuestionId = questionSelect.value;
        if (selectedQuestionId !== "") {
            analysisPlaceholder.style.display = 'none';
            analysisTabs.style.display = 'flex';
            analysisContent.style.display = 'block';
            Promise.all([
                fetchSurveyData(selectedQuestionId),
                fetchAnalysisMethods(selectedQuestionId)
            ]);
        } else {
            analysisPlaceholder.style.display = 'block';
            analysisTabs.style.display = 'none';
            analysisContent.style.display = 'none';
        }
    }

    initializeSurveyTable();
    questionSelect.addEventListener('change', handleQuestionChange);
    if (questionSelect.value) handleQuestionChange();

    $(window).on('resize', function() {
        surveyTable.columns.adjust().draw();
    });
});
</script>
{% endblock %}