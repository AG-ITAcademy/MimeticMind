{% extends 'base.html' %}

{% block content %}
<script src="{{ url_for('static', filename='assets/js/population_charts.js') }}"></script>
    
<div class="container-fluid">
    <div class="row g-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">{{ population.name }}</h2>
                    <p>{{ population.description }}</p>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-4">
                            <form id="filter-form" method="POST" action="{{ url_for('population_explorer_bp.population_explorer') }}">
                                {{ form.hidden_tag() }}
                                {% for field in form if field.name != 'csrf_token' %}
                                <div class="mb-0 row align-items-center">
                                    <label for="{{ field.id }}" class="col-sm-6 col-form-label">{{ field.label.text }}</label>
                                    <div class="col-sm-6">
                                        {{ field(class="form-select form-select-sm" if field.type == "SelectField" else "form-control form-control-sm") }}
                                    </div>
                                </div>
                                {% endfor %}
                                <div class="mt-0">
                                    <button type="submit" class="btn btn-outline-primary btn-sm w-100">Apply Filters</button>
                                </div>
                            </form>
                        </div>

                        <div class="col-sm-8">
                            <ul class="nav nav-tabs mb-3" id="visualization-tabs" role="tablist" data-tab-has-echarts="data-tab-has-echarts">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="age-groups-tab" data-bs-toggle="tab" data-bs-target="#age-groups" type="button" role="tab" aria-controls="age-groups" aria-selected="true">Age Groups</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="gender-distribution-tab" data-bs-toggle="tab" data-bs-target="#gender-distribution" type="button" role="tab" aria-controls="gender-distribution" aria-selected="false">Gender Distribution</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="visualization-content">
                                <div class="tab-pane fade show active" id="age-groups" role="tabpanel" aria-labelledby="age-groups-tab">
                                    <div class="echart-age-groups-pie" data-echart-responsive="true" data-echart-tab="data-echart-tab" style="height: 400px;"></div>
                                </div>
                                <div class="tab-pane fade" id="gender-distribution" role="tabpanel" aria-labelledby="gender-distribution-tab">
                                    <div class="echart-gender-distribution" data-echart-responsive="true" data-echart-tab="data-echart-tab" style="height: 400px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <table id="profile-table" class="table table-striped table-bordered table-md" style="width:100%">
                    </table>
                </div>
            </div>
        </div>

<!--
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <button class="btn btn-primary btn-sm">Save Population Segment</button>
                </div>
            </div>
        </div>
 -->       
    </div>
</div>

<script>
$(document).ready(function() {
    const form = $('#filter-form');
    
        // Initialize ECharts instances and charts
    echartAgeGroupsPieInit();   // Initialize age groups pie chart
    echartGenderDistributionInit(); // Initialize gender distribution pie chart
    
    // Initialize ECharts instances
    const ageGroupsChart = echarts.init($('.echart-age-groups-pie')[0]);
    const genderDistributionChart = echarts.init($('.echart-gender-distribution')[0]);

    // Initialize DataTable
    const profileTable = $('#profile-table').DataTable({
        pageLength: 5,
        lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
        columns: [
            { data: 'profile_name', title: 'Profile Name' },
            { data: 'gender', title: 'Gender' },
            { data: 'education_level', title: 'Education Level' },
            { data: 'occupation', title: 'Occupation' },
            { data: 'income_range', title: 'Income Range' }
        ],
        data: {{ profiles | tojson | safe }}
    });

    form.on('submit', function(e) {
        e.preventDefault();
        fetchAndUpdateData(new FormData(this));
    });

    function updateCharts(data) {
        updatePopulationCharts(data);
        profileTable.clear().rows.add(data.data).draw();
    }

    function fetchAndUpdateData(formData = new FormData()) {
        formData.append('population', '{{ population.tag }}');
        $.ajax({
            url: '{{ url_for('population_explorer_bp.population_explorer') }}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                console.log("Received data:", data);
                updateCharts(data);
            },
            error: function(error) {
                console.error('Error fetching data:', error);
            }
        });
    }

    function waitForCharts(callback) {
        if (window.populationAgeGroupsChart && window.populationGenderDistributionChart) {
            callback();
        } else {
            setTimeout(() => waitForCharts(callback), 100);
        }
    }

    // Initialize charts with preloaded data
    const initialChartData = {
        age_groups: {{ age_groups | tojson | safe }},
        gender_distribution: {{ gender_distribution | tojson | safe }}
    };

    waitForCharts(() => {
        updatePopulationCharts(initialChartData);
    });

    $(window).on('resize', function() {
        if (window.populationAgeGroupsChart) {
            window.populationAgeGroupsChart.resize();
        }
        if (window.populationGenderDistributionChart) {
            window.populationGenderDistributionChart.resize();
        }
        profileTable.columns.adjust().draw();
    });
});
</script>

{% endblock %}